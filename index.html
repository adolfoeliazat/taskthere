<!doctype html>
<html><head>
<meta charset="utf-8">
<title>To Do There</title>
<style>
html { height: 100%; } body { font-family: sans; margin: 0; padding: 0; position: relative; height: 100%; } h1 { font-size: 150%; font-weight: normal; background: #000; color: #fff; margin: 0; padding: 10px;} select { width: 100%; display: inline-block; } select, input, legend { font-size: 24px; } #new { display: inline-block; width: 100%;} #t { margin: 0; padding: 0; } #t li { background: #eee; list-style-type: none; margin: 0 padding: 10px; } #t li:nth-child(2n) { background: #ddd; } a { display: block; padding: 5px; text-decoration: none;} a:hover { color: red; } a:hover:after { content: '\a0 \2612'; } #about {color: #fff; background: #000; width: 100%;/*position: absolute; bottom: -90px;-webkit-transition: all 1s ease-in-out;-moz-transition: all 1s ease-in-out;-o-transition: all 1s ease-in-out;-ms-transition: all 1s ease-in-out;transition: all 1s ease-in-out;*/ } #about:hover {bottom: 0;} </style>
</head>
<body>
<div id="place-selector">

<h1>
  <table width="100%"><tr><td width="110">To Do @</td>
  <td><select id="p"></select></td>

  <td width="150">
  	<input type="button" onclick="on.startEditPlace();return false" value="Edit" />
  	<label>GPS<input id="gps" value="on" type="checkbox" /></label>
  </td>
  </tr></table>
</h1>

</div>

<fieldset style="display:none" id="edit-place"">
  <legend>Edit place</legend>

  Name: <input id="place-name" value="" /><br />
  Lat: <input id="place-lat" value="" /><br />
  Long: <input id="place-lng" value="" /><br />
  <input type="button" value="Here" onclick="on.hereEditPlace()"/>
  <input type="button" value="Save" onclick="on.saveEditPlace()"/>
  <input type="button" value="Cancel" onclick="on.cancelEditPlace()" />
  <input type="button" value="Delete" onclick="on.deleteEditPlace()" />

</fieldset>

<form>
  <table width="100%"><tr><td>
  <input id="new" placeholder="Enter task&hellip;" />
  </td><td width="110">
  <input type="submit" value="Add" onclick="return on.addTask()" />
  </td></tr></table>
</form>

<ul id="t">
</ul>

<div id="about">

<p>
  <b>To Do There</b> lets you save places then add tasks to them. 
  Select <em>New place&hellip;</em> from the menu to create a new place.
  Enter tasks into the text box; click on them in the list to delete them.
  <!--Toggle updating GPS with the GPS checkbox.-->
</p>

<p>
  &copy; 2011 Dave Hulbert. Version 0.5. Built Thu Jul 28 22:50:15 2011 +0100

</p>

</div>

<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
<script>

/*
set gps checkbox to localStorage.gps on load
on gps checkbox change:
	save state to localstorage.gps
	show it as in progress (animation)
	start getting gps position
	setInterval for getting gps position 
	when gps position found
		save to localstorage (& restore)
		update select box & trigger change
*/


function GpsChecker(success) {
	this.lat = 0;
	this.lng = 0;
	this.active = null;

	// get from localStorage
	this.restoreState();

	this.registerEvents();
}

GpsChecker.prototype.interval = null;
GpsChecker.prototype.period = 1000 * 6 * 10; // 10 minutes

GpsChecker.prototype.registerEvents = function() {
	var me = this;

	$('#gps').click(function() {
		if ($(this).attr('checked')) {
			me.active = true;
			me.saveState();
			me.setInterval();
		} else {
			me.active = false;
			me.saveState();
			if (me.interval) {
				clearInterval(me.interval);
			}
		}
	});	
};

GpsChecker.prototype.restoreState = function() {
	var props = localStorage.gps ? JSON.parse(localStorage.gps) : {
		active: false,
		lat: 0,
		lng: 0
	};

	this.active = props.active;
	this.lat = props.lat;
	this.lng = props.lng;

	if (this.lat && this.lng) {
		var me = this;
		// use the lat lat/lng for now
		setTimeout(function() {
			placeManager.gpsSuccess(me);
		}, 1);
	}

	if (this.active) {
		$('#gps').attr('checked', 'checked');
		this.activate();
	} else {
		$('#gps').removeAttr('checked', false);	
	}
};

GpsChecker.prototype.saveState = function() {
	localStorage.gps = JSON.stringify(this);
};

GpsChecker.prototype.activate = function() {
	this.inProgress();
	this.getPosition();
};

GpsChecker.prototype.inProgress = function() {
	//console.log('looking for position');
	$('#gps').parent().css('background', '#ccc');
};

GpsChecker.prototype.finishedProgress = function() {
	//console.log('finished looking for position');
	$('#gps').parent().css('background', 'none');
};

GpsChecker.prototype.getPosition = function() {
	var me = this;
	navigator.geolocation.getCurrentPosition(function(position) {
		me.onSuccess(position);
	}, function(error) {
		this.onFail(error);
	});	
};

GpsChecker.prototype.setInterval = function() {
	//console.log('set interval', this);
	var me = this;
	this.activate();
	this.interval = setInterval(function() {
		me.activate();
	}, this.period);
};

GpsChecker.prototype.onSuccess = function(position) {
	this.lat = position.coords.latitude;
	this.lng = position.coords.longitude;

	this.finishedProgress();

	var me = this;
	setTimeout(function() {
		placeManager.gpsSuccess(me);
	}, 1);
};

GpsChecker.prototype.onFail = function(error) {
	//console.log('fail');
	this.finishedProgress();
};



function Place(opts, tasks) {
	this.name = opts.name;
	this.lat = opts.lat;
	this.lng = opts.lng;
	this.tasks = tasks || [];
}

Place.prototype.addTask = function(task) {
	this.tasks.push(task);
}


Place.prototype.add = function() {
};

Place.prototype.startEdit = function() {
};

Place.prototype.save = function(opts) {
	this.name = opts.name;
	this.lat = opts.lat;
	this.lng = opts.lng;
};

Place.prototype.delete = function() {
};

Place.prototype.deleteTask = function(task) {
	for (var i in this.tasks) {
		if (this.tasks[i].title === task.title) {
			this.tasks.splice(i, 1);
			return;
		}
	}
};

Place.prototype.select = function() {
	var html = '';
	var tasks = this.tasks;
	var a, task;
	elements.taskContainer.html('');	
	for (var i in tasks) {
		task = tasks[i];
		elements.taskContainer.append(task.getHtml());
	}
};

Place.prototype.getOptionHtml = function() {
	var escaped = this.name.replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/'/g, '&#039;').replace(/"/g, '&quot;');
	return '<option>' + this.name + '</option>';
};

Place.prototype.addTask = function(task) {
	this.tasks.push(task);
};

Place.prototype.distanceTo = function(position) {
	console.log(position.lat, position.lng);
	console.log(this.lat, this.lng);

	function toRad(deg) {
		return deg *(Math.PI/180);
	}

	var R = 6371; // km
	var d = Math.acos(
				Math.sin(toRad(position.lat)) * Math.sin(toRad(this.lat)) + 
	            Math.cos(toRad(position.lat)) * Math.cos(toRad(this.lat)) *
	            Math.cos(toRad(this.lng) - toRad(position.lng))
	        ) * R;
	console.log(d);
	return d;
};

function Task(title) {
	this.title = title;
}

Task.prototype.getHtml = function() {
	var me = this;	
	var html = $('<a href="javascript:void(0)"> </a>')
		.text(this.title || 'No title')
		.wrap('<li />').parent()
		.click(function() {
			me.delete();
		});
	return html;
};

Task.prototype.delete = function() {
	placeManager.getCurrent().deleteTask(this);
	placeManager.update();
};

if (!window.console) {
	window.console = {
		log: function() {}
	};
}

var elements = {
	placeSelect: $('#p'),
	taskContainer: $('#t'),
	taskInput: $('#new'),
	gps: $('#gps') 
};

var placeManager = {
	getCurrentPlaceName: function() {
		return elements.placeSelect.val();
	},
	getCurrent: function() {
		var n = placeManager.getCurrentPlaceName();
		for (var i in placeManager.places) {
			if (placeManager.places[i].name == n) {
				return placeManager.places[i];
			}
		}
		throw 'No current place';
	},
	update: function() {
		// save the tasks/places & trigger a rebuild of the task list
		placeManager.saveToStorage();
		elements.placeSelect.change();
	},
	saveToStorage: function() {
		localStorage.places = JSON.stringify(placeManager.places); 
	},
	taskArrayToObjects: function(tasks_array) {
		var tasks = [];
		for (var i in tasks_array) {
				tasks.push(new Task(tasks_array[i].title));
		}		
		return tasks;
	},
	restoreFromStorage: function() {
		// restore from last session if it exists
		var places = localStorage.places ? JSON.parse(localStorage.places) : [];
		var tasks;
		for (var i in places) {
			tasks = placeManager.taskArrayToObjects(places[i].tasks);
			placeManager.places.push(new Place(places[i], tasks));
		}
	},
	placeNameExists: function(place_name) {
		for (var i in placeManager.places) {
			if (placeManager.places[i].name === place_name) {
				return true;
			}
		}
		return false;
	},
	startNewPlace: function() {
		var place_name = prompt('Enter new place name: ');
		if (!place_name) {
			alert('Please enter a place name');
			return;
		}

		if (placeManager.placeNameExists(place_name)) {
			alert('Place "' + place_name + '" already exists.');
			return;
		}
		
		var opts = {
			name: place_name,
			lat: 0,
			lng: 0,
		};

		var tasks = [];
		var place = new Place(opts, tasks);
		
		navigator.geolocation.getCurrentPosition(function(position) {
			opts.lat = position.coords.latitude;
			opts.lng = position.coords.longitude;
			place.save(opts);
		}, function(error) {
			alert(error.message);	
		});

		placeManager.places.push(place);
		placeManager.saveToStorage();
		placeManager.buildSelect();
		elements.placeSelect.val(place_name);
		placeManager.update();
	},
	deletePlace: function(place) {
		for (var i in placeManager.places) {
			if (placeManager.places[i].name === place.name) {
				// this will delete the 1st place with the same name
				placeManager.places.splice(i, 1);
				return;
			}
		}
	},
	buildSelect: function() {
		// TODO: show task count and distance to current location
		// TODO: sort order: alphabetical or distance
		var options = '';
		var place;
		for (var i in placeManager.places) {
			place = placeManager.places[i];
			options += place.getOptionHtml();
		}
		options += '<option value="" id="new-place-option">New place&hellip;</option>';
		elements.placeSelect.html(options);
	},
	registerEvents: function() {
		elements.placeSelect.change(on.placeSelectChange);
	},
	// array of place objects
	places: [],
	gpsSuccess: function(position) {
		placeManager.selectNearestPlace(position);
	},
	selectNearestPlace: function(position) {
		var nearestPlace;
		var closestDistance = 6371 * 2; // assume we're the other side of the earth
		for (var i in placeManager.places) {
			var dist = placeManager.places[i].distanceTo(position);
			console.log(dist);
			if (dist < closestDistance) {
				console.log('nearest!');
				nearestPlace = placeManager.places[i];
			}
		}

		if (nearestPlace) {
			if (nearestPlace.name !== placeManager.getCurrent().name) {
				console.log('changing place to ' + nearestPlace.name + ', which is ' + dist + 'km away');

				elements.placeSelect.val(nearestPlace.name);
				placeManager.update();
				
			}
		}
	},
	gpsChecker: new GpsChecker()
};

// event handlers
var on = {
	addTask: function() {
		var title = $('#new').val();
		if (!title) {
			alert('Enter details for task');
			return false;
		}
		if (!placeManager.getCurrentPlaceName()) {
			alert('Add a place before adding a task');
			return false;
		}
		var t = new Task(title);
		var p = placeManager.getCurrent();
		p.addTask(t);
		placeManager.update();
		$('#new').val('');
		return false;	
	},
	placeSelectChange: function() {
		if (elements.placeSelect.val() == '') {
			placeManager.startNewPlace();
			return;
		}
		var p = placeManager.getCurrent();
		p.select();
		elements.taskInput.focus();
	},
	startEditPlace: function() {
		$('#edit-place').show();
		$('#place-selector').hide();

		var p = placeManager.getCurrent();
		$('#place-name').val(p.name);
		$('#place-lat').val(p.lat);
		$('#place-lng').val(p.lng);
	},
	cancelEditPlace: function() {
		$('#edit-place').hide();
		$('#place-selector').show();
	},
	saveEditPlace: function() {
		var opts = {
			name: $('#place-name').val(),
			lat: $('#place-lat').val(),
			lng: $('#place-lng').val()
		};
		placeManager.getCurrent().save(opts);
		placeManager.saveToStorage();
		placeManager.buildSelect();
		elements.placeSelect.val(opts.name);
		placeManager.update();
		on.cancelEditPlace();
	},
	deleteEditPlace: function() {
		if (!confirm("Are you sure you want to delete this place and all it's tasks?")) {
			on.cancelEditPlace();
			return;
		}
		placeManager.deletePlace(placeManager.getCurrent());
		placeManager.saveToStorage();
		placeManager.buildSelect();
		//elements.placeSelect.val(opts.name);
		placeManager.update();
		on.cancelEditPlace();
	},
	hereEditPlace: function() {
		// set the current place the current geolocation
		// then close & save the edit, or just set the input fields
	}
};

function load_page() {
	placeManager.restoreFromStorage();
	placeManager.buildSelect();
	placeManager.registerEvents();
	placeManager.update();
}

load_page();
//alert('js ok');
</script>
</body>
</html>


